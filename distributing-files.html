
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Distributing Files &#8212; Skein 0.1.1+19.geca43a0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Key-Value Store" href="key-value-store.html" />
    <link rel="prev" title="Specification" href="specification.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="distributing-files">
<h1>Distributing Files<a class="headerlink" href="#distributing-files" title="Permalink to this headline">¶</a></h1>
<p>Most applications require some number of files (executables, configuration,
scripts, etc…) to run. When deploying these applications on YARN you have
two options depending on the kind of access you want to assume:</p>
<ol class="arabic simple">
<li><strong>IT Permissions</strong>: Install the files on every node in the cluster. This
usually requires a cluster administrator, and is often only done for things
like commonly used libraries. For example, you might install Python and
common libraries on every node, but not your application code.</li>
<li><strong>User Permissions</strong>: Distribute the files to the executing containers as
part of the application.  This is the common approach, and does not require
administrator privileges.</li>
</ol>
<p>Both options have their place, and can be mixed in a single application. Below
we discuss the second option in detail.</p>
<div class="section" id="specifying-files-for-a-service">
<h2>Specifying Files for a Service<a class="headerlink" href="#specifying-files-for-a-service" title="Permalink to this headline">¶</a></h2>
<p>Files for distribution are specified per-service using the <a class="reference internal" href="specification.html#specification-files"><span class="std std-ref">files field of
the specification</span></a>. This field takes a mapping of
destination relative paths to <code class="xref py py-class docutils literal notranslate"><span class="pre">File</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code> objects describing
the sources for these paths. Each <code class="xref py py-class docutils literal notranslate"><span class="pre">File</span></code> object takes the following
fields:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">source</span></code></p>
<p>The path to the file/archive. If no scheme is specified, the path is assumed
to be on the local filesystem (<code class="docutils literal notranslate"><span class="pre">file://</span></code> scheme). Relative paths are
supported, and are taken relative to the location of the specification file.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">type</span></code></p>
<p>The type of file to distribute – either <code class="docutils literal notranslate"><span class="pre">archive</span></code> or <code class="docutils literal notranslate"><span class="pre">file</span></code>.  Archive’s
are automatically extracted by yarn into a directory with the same name as
their destination (only <code class="docutils literal notranslate"><span class="pre">.zip</span></code>, <code class="docutils literal notranslate"><span class="pre">.tar.gz</span></code>, and <code class="docutils literal notranslate"><span class="pre">.tgz</span></code> supported).
Optional; by default the type is inferred from the file extension.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">visibility</span></code></p>
<p>The resource visibility. Describes how resources are shared between
applications. Valid values are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">application</span></code> – Shared among containers of the same application on the node.</li>
<li><code class="docutils literal notranslate"><span class="pre">private</span></code> – Shared among all applications of the same user on the node.</li>
<li><code class="docutils literal notranslate"><span class="pre">public</span></code> – Shared by all users on the node.</li>
</ul>
<p>Optional, default is <code class="docutils literal notranslate"><span class="pre">application</span></code>. In most cases the default is what you
want.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">size</span></code></p>
<p>The resource size in bytes. Optional; if not provided will be determined by
the file system. In most cases the default is what you want.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></p>
<p>The time the resource was last modified. Optional; if not provided will be
determined by the file system. In most cases the default is what you want.</p>
</li>
</ul>
<p>As a shorthand, values may be the source path instead of a <code class="xref py py-class docutils literal notranslate"><span class="pre">File</span></code>
object.</p>
<p><strong>Example</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">my_service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">files</span><span class="p p-Indicator">:</span>
      <span class="c1"># /local/path/to/file.zip will be uploaded to HDFS, and extracted</span>
      <span class="c1"># into the directory path_on_container</span>
      <span class="l l-Scalar l-Scalar-Plain">path_on_container</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">source</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/local/path/to/file.zip</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">archive</span>

      <span class="c1"># Can also specify only the source path - missing fields are inferred</span>
      <span class="l l-Scalar l-Scalar-Plain">script_path.py</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/script.py</span>

      <span class="c1"># Files on remote filesystems can be used by specifying the scheme.</span>
      <span class="c1"># If the specified filesystem matches the default filesystem</span>
      <span class="c1"># (typically HDFS), uploading will is avoided, allowing for faster</span>
      <span class="c1"># application startup.</span>
      <span class="l l-Scalar l-Scalar-Plain">script2_path.py</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">hdfs:///remote/path/to/script2.py</span>
</pre></div>
</div>
</div>
<div class="section" id="the-file-distribution-process">
<h2>The File Distribution Process<a class="headerlink" href="#the-file-distribution-process" title="Permalink to this headline">¶</a></h2>
<p>When an application launches, the following process occurs:</p>
<ol class="arabic simple">
<li>An application staging directory is created in the user’s home directory on
the default filesystem (typically HDFS). The path for this is the format
<code class="docutils literal notranslate"><span class="pre">~/.skein/{application</span> <span class="pre">id}</span></code>.</li>
<li>The missing fields for each file in the application specification are
inferred. All files that are not already on the default filesystem are
copied over. Note that if a file is used by more than once service, it is
only copied over once for the application.</li>
<li>The application is started.</li>
<li>When a container is started, YARN resource localization is applied for every
file specified by that service. During this process files are copied to the
container and any archives are extracted to the destination directories.
Based on the file <code class="docutils literal notranslate"><span class="pre">visibility</span></code> setting, this may be done once per node per
application, or once per node (with an LRU cache for clearing old files).
For more information on this process see <a class="reference external" href="https://hortonworks.com/blog/resource-localization-in-yarn-deep-dive/">this blogpost from Hortonworks</a>.</li>
<li>When the application completes, the staging directory is deleted.</li>
</ol>
</div>
<div class="section" id="distributing-python-environments">
<h2>Distributing Python Environments<a class="headerlink" href="#distributing-python-environments" title="Permalink to this headline">¶</a></h2>
<p>When deploying Python applications, one needs to figure out how to distribute
any library dependencies. If Python and the required libraries are already
installed on every node (option 1 above), you can use the local Python and
avoid this problem completely. If they aren’t, then one needs to package the
environment to distribute with the application. This is typically handled using</p>
<ul class="simple">
<li><a class="reference external" href="https://conda.github.io/conda-pack/">conda-pack</a> for <a class="reference external" href="http://conda.io/">conda</a> environments</li>
<li><a class="reference external" href="https://jcrist.github.io/venv-pack/">venv-pack</a>  for virtual environments (both <a class="reference external" href="https://docs.python.org/3/library/venv.html">venv</a> and <a class="reference external" href="https://virtualenv.pypa.io/en/stable/">virtualenv</a> supported)</li>
</ul>
<p>Both are tools for taking an environment and creating an archive of it in a way
that (most) absolute paths in any libraries or scripts are altered to be
relocatable. This archive then can be distributed with your application, and
will be automatically extracted during <a class="reference external" href="https://hortonworks.com/blog/resource-localization-in-yarn-deep-dive/">YARN resource localization</a></p>
<div class="section" id="packaging-a-conda-environment-with-conda-pack">
<h3>Packaging a Conda Environment with Conda-Pack<a class="headerlink" href="#packaging-a-conda-environment-with-conda-pack" title="Permalink to this headline">¶</a></h3>
<p>Here we create a conda environment using <a class="reference external" href="http://conda.io/">conda</a>, and then use
<a class="reference external" href="https://conda.github.io/conda-pack/">conda-pack</a> to package the environment into a <code class="docutils literal notranslate"><span class="pre">tar.gz</span></code> file named
<code class="docutils literal notranslate"><span class="pre">environment.tar.gz</span></code>. This is what will be distributed with our application.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new conda environment</span>
$ conda create -n example
...

<span class="c1"># Activate the environment</span>
$ conda activate example

<span class="c1"># Install the needed packages</span>
$ conda install conda-pack skein numpy scikit-learn numba -c conda-forge
...

<span class="c1"># Package the environment into environment.tar.gz</span>
$ conda pack -o environment.tar.gz
Collecting packages...
Packing environment at <span class="s1">&#39;/home/jcrist/miniconda/envs/example&#39;</span> to <span class="s1">&#39;environment.tar.gz&#39;</span>
<span class="o">[</span><span class="c1">########################################] | 100% Completed | 24.2s</span>
</pre></div>
</div>
</div>
<div class="section" id="packaging-a-virtual-environment-with-venv-pack">
<h3>Packaging a Virtual Environment with Venv-Pack<a class="headerlink" href="#packaging-a-virtual-environment-with-venv-pack" title="Permalink to this headline">¶</a></h3>
<p>Here we create a virtual environment, and then use <a class="reference external" href="https://jcrist.github.io/venv-pack/">venv-pack</a> to package it
into a <code class="docutils literal notranslate"><span class="pre">tar.gz</span></code> file named <code class="docutils literal notranslate"><span class="pre">environment.tar.gz</span></code>. This is what will be
distributed with our application. The virtual environment can be created using
either <a class="reference external" href="https://docs.python.org/3/library/venv.html">venv</a> or <a class="reference external" href="https://virtualenv.pypa.io/en/stable/">virtualenv</a>.</p>
<p>Note that the python linked to in the virtual environment must exist and be
accessible on every node in the YARN cluster. If the environment was created
with a different Python, you can change the link path using the
<code class="docutils literal notranslate"><span class="pre">--python-prefix</span></code> flag. For more information see the <a class="reference external" href="https://jcrist.github.io/venv-pack/">venv-pack
documentation</a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a virtual environment</span>
$ python -m venv example            <span class="c1"># Using venv</span>
$ python -m virtualenv example      <span class="c1"># Or using virtualenv</span>
...

<span class="c1"># Activate the environment</span>
$ <span class="nb">source</span> example/bin/activate

<span class="c1"># Install the needed packages</span>
$ pip install venv-pack skein numpy scikit-learn numba
...

<span class="c1"># Package the environment into environment.tar.gz</span>
$ venv-pack -o environment.tar.gz
Collecting packages...
Packing environment at <span class="s1">&#39;/home/jcrist/environments/example&#39;</span> to <span class="s1">&#39;environment.tar.gz&#39;</span>
<span class="o">[</span><span class="c1">########################################] | 100% Completed |  12.4s</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-packaged-environment">
<h3>Using the Packaged Environment<a class="headerlink" href="#using-the-packaged-environment" title="Permalink to this headline">¶</a></h3>
<p>To use the packaged environment in a service specification, you need to include
the archive in <code class="docutils literal notranslate"><span class="pre">files</span></code>, and activate the environment in the <code class="docutils literal notranslate"><span class="pre">commands</span></code>
list. This looks the same for environments packaged using either tool.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">my_service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">files</span><span class="p p-Indicator">:</span>
      <span class="c1"># The environment archive will be uploaded to HDFS, and extracted</span>
      <span class="c1"># into a directory named ``environment`` in each container.</span>
      <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">environment.tar.gz</span>

    <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
      <span class="c1"># Activate the environment</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">source environment/bin/activate</span>

      <span class="c1"># Run commands inside the environment. All executables or imported</span>
      <span class="c1"># python libraries will be from within the packaged environment.</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my-cool-application</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo.svg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">A tool and library for easily deploying applications on Apache YARN</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jcrist&repo=skein&type=watch&count=False&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jcrist/skein">
    <img
        alt="https://secure.travis-ci.org/jcrist/skein.svg?branch=master"
        src="https://secure.travis-ci.org/jcrist/skein.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="specification.html">Specification</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Distributing Files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#specifying-files-for-a-service">Specifying Files for a Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-file-distribution-process">The File Distribution Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="#distributing-python-environments">Distributing Python Environments</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="key-value-store.html">Key-Value Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="web-ui.html">Web UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Docs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="develop.html">Development</a></li>
</ul>

<h3>Need help?</h3>

<p>
  Open an issue in the <a href="https://github.com/jcrist/skein/issues">issue tracker</a>.
</p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Jim Crist.
      
      |
      <a href="_sources/distributing-files.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>